<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Vehicles - Prodigy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cream': '#EFE4D2',
                        'blue-dark': '#254D70',
                        'navy': '#131D4F',
                        'brown': '#954C2E'
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                        'display': ['Poppins', 'system-ui', '-apple-system', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .vehicle-card {
            transition: all 0.3s ease;
        }
        .vehicle-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .add-vehicle-card {
            transition: all 0.3s ease;
        }
        .add-vehicle-card:hover {
            background: linear-gradient(135deg, #254D70, #131D4F);
            transform: translateY(-2px);
        }
        
        /* Page Transition Animation */
        body {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Flatpickr customization */
        .flatpickr-calendar {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
            border-radius: 12px !important;
            border: 1px solid #e5e7eb !important;
        }
        
        .flatpickr-day.selected {
            background: #254D70 !important;
            border-color: #254D70 !important;
        }
        
        .flatpickr-day:hover {
            background: #EFE4D2 !important;
            border-color: #254D70 !important;
        }
        
        .flatpickr-day.today {
            background: #954C2E !important;
            border-color: #954C2E !important;
            color: white !important;
        }
    </style>
</head>
<body class="bg-cream min-h-screen font-sans">
    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-navy via-blue-dark to-navy shadow-2xl border-b border-blue-dark/20">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-5">
                <div class="flex items-center space-x-3">
                    <div class="relative">
                        <i class="fas fa-car text-cream text-3xl" style="text-shadow: 0 0 10px rgba(239, 228, 210, 0.5);"></i>
                        <div class="absolute -top-1 -right-1 w-3 h-3 bg-brown rounded-full opacity-75 animate-pulse"></div>
                    </div>
                    <div>
                        <h1 class="text-cream text-3xl font-bold font-display tracking-wide" style="text-shadow: 0 0 10px rgba(239, 228, 210, 0.5);">Prodigy</h1>
                        <p class="text-cream/70 text-xs font-medium tracking-widest uppercase">Auto Care</p>
                    </div>
                </div>
                
                <div class="hidden lg:flex items-center space-x-6">
                    <a href="index.html" class="text-cream hover:text-cream/90 transition-all duration-300 font-medium">Home</a>
                    <a href="bookings.html" class="text-cream hover:text-cream/90 transition-all duration-300 font-medium">My Bookings</a>
                    <a href="#" class="text-cream font-semibold border-b-2 border-cream pb-1">My Vehicles</a>
                    <a href="profile.html" class="text-cream hover:text-cream/90 transition-all duration-300 font-medium">Profile</a>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="hidden md:block bg-white/10 backdrop-blur-sm rounded-xl px-4 py-2 border border-white/20">
                        <div class="text-cream text-sm">
                            <div id="user-name" class="font-semibold">Loading...</div>
                            <div class="flex items-center space-x-1 text-xs opacity-90">
                                <i class="fas fa-star text-yellow-400"></i>
                                <span id="loyalty-points">0 points</span>
                            </div>
                        </div>
                    </div>
                    
                    <button id="logout-btn" class="bg-gradient-to-r from-brown to-brown/80 text-white px-6 py-3 rounded-xl hover:shadow-lg transition-all duration-300 font-medium">
                        <i class="fas fa-sign-out-alt mr-2"></i>Sign Out
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold font-display text-navy mb-2">My Vehicles</h1>
            <p class="text-gray-600">Manage your registered vehicles for car wash bookings</p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Vehicles</p>
                        <p class="text-3xl font-bold font-display text-navy" id="total-vehicles">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-car text-blue-dark text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Most Used Vehicle</p>
                        <p class="text-lg font-bold text-navy" id="most-used-vehicle">None</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-trophy text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Last Service</p>
                        <p class="text-lg font-bold text-navy" id="last-service">Never</p>
                    </div>
                    <div class="w-12 h-12 bg-brown-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-calendar text-brown text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vehicles Grid -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold font-display text-navy">Your Vehicles</h2>
                <button id="add-vehicle-btn" class="bg-blue-dark text-white px-6 py-3 rounded-lg font-semibold hover:bg-navy transition-colors">
                    <i class="fas fa-plus mr-2"></i>Add Vehicle
                </button>
            </div>

            <!-- Loading State -->
            <div id="vehicles-loading" class="text-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-dark mx-auto mb-4"></div>
                <p class="text-gray-500">Loading your vehicles...</p>
            </div>

            <!-- Empty State -->
            <div id="no-vehicles" class="text-center py-12 hidden">
                <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-car text-4xl text-gray-400"></i>
                </div>
                <h3 class="text-xl font-semibold text-navy mb-2">No Vehicles Yet</h3>
                <p class="text-gray-600 mb-6">Add your first vehicle to start booking car wash services</p>
                <button id="add-first-vehicle-btn" class="bg-blue-dark text-white px-8 py-3 rounded-lg font-semibold hover:bg-navy transition-colors">
                    <i class="fas fa-plus mr-2"></i>Add Your First Vehicle
                </button>
            </div>

            <!-- Vehicles Grid -->
            <div id="vehicles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
                <!-- Vehicles will be populated by JavaScript -->
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-xl shadow-lg p-6 mt-8">
            <h2 class="text-xl font-bold font-display text-navy mb-6">Recent Vehicle Activity</h2>
            <div id="recent-activity" class="space-y-4">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </main>

    <!-- Add/Edit Vehicle Modal -->
    <div id="vehicle-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-xl font-bold text-navy">Add New Vehicle</h3>
                <button id="close-vehicle-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="vehicle-form" class="space-y-4">
                <div>
                    <label for="vehicle-make" class="block text-sm font-medium text-gray-700 mb-1">Make *</label>
                    <input type="text" id="vehicle-make" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-dark focus:border-blue-dark" placeholder="e.g., Toyota, Honda, Ford" required>
                </div>
                
                <div>
                    <label for="vehicle-model" class="block text-sm font-medium text-gray-700 mb-1">Model *</label>
                    <input type="text" id="vehicle-model" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-dark focus:border-blue-dark" placeholder="e.g., Vios, Civic, F-150" required>
                </div>

                <div>
                    <label for="vehicle-type" class="block text-sm font-medium text-gray-700 mb-1">Vehicle Type *</label>
                    <select id="vehicle-type" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-dark focus:border-blue-dark" required>
                        <option value="">Select vehicle type</option>
                        <option value="SUV">SUV</option>
                        <option value="Sedan">Sedan</option>
                        <option value="Pickup">Pickup</option>
                        <option value="Motorcycle">Motorcycle</option>
                        <option value="Van">Van</option>
                    </select>
                </div>
                
                <div>
                    <label for="vehicle-plate" class="block text-sm font-medium text-gray-700 mb-1">Plate Number *</label>
                    <input type="text" id="vehicle-plate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-dark focus:border-blue-dark" placeholder="e.g., ABC-1234" required style="text-transform: uppercase;">
                </div>

                <div class="flex space-x-4 pt-4">
                    <button type="button" id="cancel-vehicle-btn" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="save-vehicle-btn" class="flex-1 bg-blue-dark text-white py-3 rounded-lg font-semibold hover:bg-navy transition-colors">
                        <span id="save-btn-text">Add Vehicle</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md mx-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                </div>
                <h3 class="text-xl font-bold text-navy mb-2">Delete Vehicle</h3>
                <p class="text-gray-600 mb-6">Are you sure you want to delete this vehicle? This action cannot be undone.</p>
                
                <div class="flex space-x-4">
                    <button id="cancel-delete-btn" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                    <button id="confirm-delete-btn" class="flex-1 bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition-colors">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script type="module" src="firebase.js"></script>
    <script type="module">
        import { 
            auth, 
            onAuthChange, 
            getCurrentUser, 
            logoutUser,
            getUserVehicles,
            addVehicle,
            getUserBookings
        } from './firebase.js';

        let currentUser = null;
        let vehicles = [];
        let bookings = [];
        let editingVehicleId = null;

        document.addEventListener('DOMContentLoaded', function() {
            initializeVehiclesPage();
        });

        function initializeVehiclesPage() {
            onAuthChange(async (user) => {
                if (user) {
                    currentUser = await getCurrentUser();
                    if (currentUser) {
                        updateUserInfo();
                        await loadVehiclesData();
                    }
                } else {
                    // Redirect to login if not authenticated
                    window.location.href = 'login.html';
                }
            });

            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', async () => {
                try {
                    await logoutUser();
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Logout error:', error);
                }
            });

            // Modal event listeners
            initializeModals();
        }

        function updateUserInfo() {
            if (!currentUser) return;
            
            document.getElementById('user-name').textContent = currentUser.fullName;
            document.getElementById('loyalty-points').textContent = `${currentUser.loyaltyPoints} points`;
        }

        async function loadVehiclesData() {
            try {
                // Show loading state
                document.getElementById('vehicles-loading').classList.remove('hidden');
                document.getElementById('no-vehicles').classList.add('hidden');
                document.getElementById('vehicles-grid').classList.add('hidden');

                // Load vehicles and bookings
                [vehicles, bookings] = await Promise.all([
                    getUserVehicles(),
                    getUserBookings()
                ]);

                // Hide loading state
                document.getElementById('vehicles-loading').classList.add('hidden');

                // Update stats
                updateStats();

                // Display vehicles
                if (vehicles.length === 0) {
                    document.getElementById('no-vehicles').classList.remove('hidden');
                } else {
                    document.getElementById('vehicles-grid').classList.remove('hidden');
                    displayVehicles();
                }

                // Update recent activity
                updateRecentActivity();

            } catch (error) {
                console.error('Error loading vehicles data:', error);
                document.getElementById('vehicles-loading').classList.add('hidden');
                alert('Error loading vehicles. Please try again.');
            }
        }

        function updateStats() {
            // Total vehicles
            document.getElementById('total-vehicles').textContent = vehicles.length;

            // Most used vehicle
            if (vehicles.length > 0 && bookings.length > 0) {
                const vehicleUsage = {};
                bookings.forEach(booking => {
                    vehicleUsage[booking.vehicleId] = (vehicleUsage[booking.vehicleId] || 0) + 1;
                });

                const mostUsedId = Object.keys(vehicleUsage).reduce((a, b) => 
                    vehicleUsage[a] > vehicleUsage[b] ? a : b
                );

                const mostUsedVehicle = vehicles.find(v => v.id === mostUsedId);
                if (mostUsedVehicle) {
                    document.getElementById('most-used-vehicle').textContent = 
                        `${mostUsedVehicle.make} ${mostUsedVehicle.model}`;
                }
            }

            // Last service
            if (bookings.length > 0) {
                const lastBooking = bookings.sort((a, b) => 
                    new Date(b.createdAt?.seconds * 1000) - new Date(a.createdAt?.seconds * 1000)
                )[0];
                
                if (lastBooking) {
                    const lastDate = new Date(lastBooking.createdAt.seconds * 1000);
                    document.getElementById('last-service').textContent = 
                        lastDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
            }
        }

        function displayVehicles() {
            const vehiclesGrid = document.getElementById('vehicles-grid');
            vehiclesGrid.innerHTML = '';

            vehicles.forEach(vehicle => {
                const vehicleCard = createVehicleCard(vehicle);
                vehiclesGrid.appendChild(vehicleCard);
            });

            // Add "Add Vehicle" card
            const addCard = createAddVehicleCard();
            vehiclesGrid.appendChild(addCard);
        }

        function createVehicleCard(vehicle) {
            const card = document.createElement('div');
            card.className = 'vehicle-card bg-gradient-to-br from-white to-gray-50 rounded-xl shadow-lg p-6 border border-gray-200';
            
            // Get vehicle icon based on type
            const vehicleIcon = getVehicleIcon(vehicle.vehicle_type);
            
            // Count bookings for this vehicle
            const vehicleBookings = bookings.filter(b => b.vehicleId === vehicle.id);
            const completedBookings = vehicleBookings.filter(b => b.status === 'Completed').length;

            card.innerHTML = `
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 bg-blue-dark text-white rounded-lg flex items-center justify-center">
                            <i class="${vehicleIcon} text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-navy text-lg">${vehicle.make} ${vehicle.model}</h3>
                            <p class="text-sm text-gray-600">${vehicle.vehicle_type}</p>
                        </div>
                    </div>
                    <div class="relative">
                        <button class="vehicle-menu-btn p-2 text-gray-400 hover:text-gray-600 transition-colors" data-vehicle-id="${vehicle.id}">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="vehicle-menu hidden absolute right-0 mt-2 w-40 bg-white rounded-lg shadow-lg py-2 z-10" data-vehicle-id="${vehicle.id}">
                            <button class="edit-vehicle-btn block w-full text-left px-4 py-2 text-gray-800 hover:bg-gray-100 transition-colors" data-vehicle-id="${vehicle.id}">
                                <i class="fas fa-edit mr-2"></i>Edit
                            </button>
                            <button class="delete-vehicle-btn block w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 transition-colors" data-vehicle-id="${vehicle.id}">
                                <i class="fas fa-trash mr-2"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Plate Number:</span>
                        <span class="font-semibold text-navy">${vehicle.plateNumber}</span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Total Services:</span>
                        <span class="font-semibold text-navy">${completedBookings}</span>
                    </div>

                    <div class="flex justify-between items-center pt-2 border-t border-gray-200">
                        <span class="text-sm text-gray-600">Added:</span>
                        <span class="text-sm text-gray-800">${formatDate(vehicle.createdAt)}</span>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200">
                    <button class="book-service-btn w-full bg-blue-dark text-white py-2 rounded-lg font-semibold hover:bg-navy transition-colors" data-vehicle-id="${vehicle.id}">
                        <i class="fas fa-calendar-plus mr-2"></i>Book Service
                    </button>
                </div>
            `;

            // Add event listeners
            const menuBtn = card.querySelector('.vehicle-menu-btn');
            const menu = card.querySelector('.vehicle-menu');
            const editBtn = card.querySelector('.edit-vehicle-btn');
            const deleteBtn = card.querySelector('.delete-vehicle-btn');
            const bookBtn = card.querySelector('.book-service-btn');

            menuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // Close other menus
                document.querySelectorAll('.vehicle-menu').forEach(m => {
                    if (m !== menu) m.classList.add('hidden');
                });
                menu.classList.toggle('hidden');
            });

            editBtn.addEventListener('click', () => {
                editVehicle(vehicle);
                menu.classList.add('hidden');
            });

            deleteBtn.addEventListener('click', () => {
                deleteVehicle(vehicle.id);
                menu.classList.add('hidden');
            });

            bookBtn.addEventListener('click', () => {
                window.location.href = `index.html#booking-section`;
            });

            return card;
        }

        function createAddVehicleCard() {
            const card = document.createElement('div');
            card.className = 'add-vehicle-card border-2 border-dashed border-gray-300 rounded-xl p-6 cursor-pointer hover:border-blue-dark text-center bg-gradient-to-br from-blue-50 to-blue-100';
            
            card.innerHTML = `
                <div class="py-8">
                    <div class="w-16 h-16 bg-blue-dark text-white rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-plus text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-navy mb-2">Add New Vehicle</h3>
                    <p class="text-sm text-gray-600">Register another vehicle for car wash services</p>
                </div>
            `;

            card.addEventListener('click', () => {
                openVehicleModal();
            });

            return card;
        }

        function getVehicleIcon(type) {
            const icons = {
                'SUV': 'fas fa-truck',
                'Sedan': 'fas fa-car',
                'Pickup': 'fas fa-truck-pickup',
                'Motorcycle': 'fas fa-motorcycle',
                'Van': 'fas fa-van-shuttle'
            };
            return icons[type] || 'fas fa-car';
        }

        function updateRecentActivity() {
            const activityDiv = document.getElementById('recent-activity');
            
            if (bookings.length === 0) {
                activityDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No recent activity</p>';
                return;
            }

            // Show last 5 activities
            const recentBookings = bookings.slice(0, 5);
            
            activityDiv.innerHTML = recentBookings.map(booking => {
                const vehicle = vehicles.find(v => v.id === booking.vehicleId);
                const vehicleText = vehicle ? `${vehicle.make} ${vehicle.model}` : 'Unknown Vehicle';
                
                let statusColor = 'gray';
                if (booking.status === 'Completed') statusColor = 'green';
                if (booking.status === 'Pending') statusColor = 'yellow';
                if (booking.status === 'Ongoing') statusColor = 'blue';
                if (booking.status === 'Cancelled') statusColor = 'red';

                return `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-3 h-3 bg-${statusColor}-500 rounded-full"></div>
                            <div>
                                <p class="font-medium text-navy">${booking.service} - ${vehicleText}</p>
                                <p class="text-sm text-gray-600">${booking.date} at ${booking.time}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 bg-${statusColor}-100 text-${statusColor}-800 text-sm rounded-full">${booking.status}</span>
                            <p class="text-sm font-medium text-brown mt-1">₱${booking.payment?.amount || 0}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function initializeModals() {
            const vehicleModal = document.getElementById('vehicle-modal');
            const deleteModal = document.getElementById('delete-modal');
            const vehicleForm = document.getElementById('vehicle-form');

            // Vehicle modal
            document.getElementById('add-vehicle-btn').addEventListener('click', openVehicleModal);
            document.getElementById('add-first-vehicle-btn').addEventListener('click', openVehicleModal);
            document.getElementById('close-vehicle-modal').addEventListener('click', closeVehicleModal);
            document.getElementById('cancel-vehicle-btn').addEventListener('click', closeVehicleModal);

            // Delete modal
            document.getElementById('cancel-delete-btn').addEventListener('click', closeDeleteModal);

            // Form submission
            vehicleForm.addEventListener('submit', handleVehicleSubmit);

            // Auto-uppercase plate number
            document.getElementById('vehicle-plate').addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
            });

            // Click outside to close menus
            document.addEventListener('click', () => {
                document.querySelectorAll('.vehicle-menu').forEach(menu => {
                    menu.classList.add('hidden');
                });
            });
        }

        function openVehicleModal(vehicle = null) {
            editingVehicleId = vehicle?.id || null;
            const modal = document.getElementById('vehicle-modal');
            const title = document.getElementById('modal-title');
            const saveBtn = document.getElementById('save-btn-text');
            const form = document.getElementById('vehicle-form');

            if (vehicle) {
                title.textContent = 'Edit Vehicle';
                saveBtn.textContent = 'Update Vehicle';
                
                // Populate form
                document.getElementById('vehicle-make').value = vehicle.make;
                document.getElementById('vehicle-model').value = vehicle.model;
                document.getElementById('vehicle-type').value = vehicle.vehicle_type;
                document.getElementById('vehicle-plate').value = vehicle.plateNumber;
            } else {
                title.textContent = 'Add New Vehicle';
                saveBtn.textContent = 'Add Vehicle';
                form.reset();
            }

            modal.classList.remove('hidden');
        }

        function closeVehicleModal() {
            document.getElementById('vehicle-modal').classList.add('hidden');
            document.getElementById('vehicle-form').reset();
            editingVehicleId = null;
        }

        function editVehicle(vehicle) {
            openVehicleModal(vehicle);
        }

        function deleteVehicle(vehicleId) {
            editingVehicleId = vehicleId;
            document.getElementById('delete-modal').classList.remove('hidden');
            
            document.getElementById('confirm-delete-btn').onclick = async () => {
                try {
                    // For now, we'll just remove from local array since we don't have delete function
                    // In a real app, you'd call deleteVehicle(vehicleId) from firebase.js
                    vehicles = vehicles.filter(v => v.id !== vehicleId);
                    await loadVehiclesData(); // Refresh display
                    closeDeleteModal();
                    alert('Vehicle deleted successfully!');
                } catch (error) {
                    console.error('Error deleting vehicle:', error);
                    alert('Error deleting vehicle: ' + error.message);
                }
            };
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
            editingVehicleId = null;
        }

        async function handleVehicleSubmit(e) {
            e.preventDefault();
            
            const make = document.getElementById('vehicle-make').value.trim();
            const model = document.getElementById('vehicle-model').value.trim();
            const vehicleType = document.getElementById('vehicle-type').value;
            const plateNumber = document.getElementById('vehicle-plate').value.trim();
            
            if (!make || !model || !vehicleType || !plateNumber) {
                alert('Please fill in all required fields');
                return;
            }

            const saveBtn = document.getElementById('save-vehicle-btn');
            const originalText = saveBtn.innerHTML;
            
            try {
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
                saveBtn.disabled = true;
                
                if (editingVehicleId) {
                    // Update existing vehicle (would need updateVehicle function in firebase.js)
                    alert('Update functionality will be implemented');
                } else {
                    // Add new vehicle with vehicle_type field
                    await addVehicleWithType(make, model, vehicleType, plateNumber);
                }
                
                closeVehicleModal();
                await loadVehiclesData(); // Refresh the display
                
            } catch (error) {
                console.error('Error saving vehicle:', error);
                alert('Error saving vehicle: ' + error.message);
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        // Enhanced addVehicle function to include vehicle_type
        async function addVehicleWithType(make, model, vehicleType, plateNumber) {
            const user = auth.currentUser;
            if (!user) throw new Error("User not authenticated");
            
            const vehicleData = {
                userId: user.uid,
                make,
                model,
                vehicle_type: vehicleType,
                plateNumber,
                createdAt: new Date()
            };
            
            // For now, we'll use the existing addVehicle function
            // In a real implementation, you'd modify firebase.js to include vehicle_type
            return await addVehicle(make, model, plateNumber);
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            
            const date = timestamp.seconds ? 
                new Date(timestamp.seconds * 1000) : 
                new Date(timestamp);
                
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
        }
    </script>
</body>
</html>
